---
name: Container Vulnerability Scan

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write    # fÃ¼r Commit zurÃ¼ck ins Repo
  pull-requests: write

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      IMAGE: 'ci/test:latest'
      OUTDIR: security
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          load: true
          push: false
          tags: ${{ env.IMAGE }}

      - name: Create output dir
        run: mkdir -p "$OUTDIR"

      - name: Trivy scan (JSON)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE }}
          format: 'json'
          output: '${{ env.OUTDIR }}/trivy.json'
          timeout: '10m'
          ignore-unfixed: true
          vuln-type: 'os,library'
          exit-code: '0'

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin
          grype version

      - name: Grype scan (JSON)
        run: |
          grype "${IMAGE}" -o json > "${OUTDIR}/grype.json" || true

      - name: Generate Markdown report
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="${IMAGE}"
          OUT="${OUTDIR}/SCAN_REPORT.md"
          TS="$(date -u +"%Y-%m-%d %H:%M:%SZ")"

          # ZÃ¤hler aus Trivy
          TRIVY_ALL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' "$OUTDIR/trivy.json")
          TRIVY_C=$(jq '[.Results[]?.Vulnerabilities[]?|select(.Severity=="CRITICAL")] | length' "$OUTDIR/trivy.json")
          TRIVY_H=$(jq '[.Results[]?.Vulnerabilities[]?|select(.Severity=="HIGH")]     | length' "$OUTDIR/trivy.json")
          TRIVY_M=$(jq '[.Results[]?.Vulnerabilities[]?|select(.Severity=="MEDIUM")]   | length' "$OUTDIR/trivy.json")

          # ZÃ¤hler aus Grype
          GRYPE_ALL=$(jq '.matches | length' "$OUTDIR/grype.json")
          GRYPE_C=$(jq '[.matches[]?|select(.vulnerability.severity=="Critical")] | length' "$OUTDIR/grype.json")
          GRYPE_H=$(jq '[.matches[]?|select(.vulnerability.severity=="High")]     | length' "$OUTDIR/grype.json")
          GRYPE_M=$(jq '[.matches[]?|select(.vulnerability.severity=="Medium")]   | length' "$OUTDIR/grype.json")

          {
            echo "# ðŸ›¡ï¸ Container Security Report"
            echo ""
            echo "- **Image:** \`$IMAGE\`"
            echo "- **Timestamp (UTC):** $TS"
            echo ""
            echo "## Zusammenfassung"
            echo ""
            echo "| Scanner | Critical | High | Medium | Total |"
            echo "|---|---:|---:|---:|---:|"
            echo "| Trivy  | $TRIVY_C | $TRIVY_H | $TRIVY_M | $TRIVY_ALL |"
            echo "| Grype  | $GRYPE_C | $GRYPE_H | $GRYPE_M | $GRYPE_ALL |"
            echo ""
            echo "## Trivy â€“ Top Findings (Critical/High, max 25)"
            echo ""
            echo "| Severity | ID | Package | Installed | Fixed | Title |"
            echo "|---|---|---|---|---|---|"
            jq -r '
              [.Results[]?.Vulnerabilities[]? |
                select(.Severity=="CRITICAL" or .Severity=="HIGH") |
                {
                  sev:.Severity,
                  id:.VulnerabilityID,
                  pkg:.PkgName,
                  inst:(.InstalledVersion // "-"),
                  fix:(.FixedVersion // "-"),
                  title:(.Title // .Description // "-")
                }] |
              .[:25] |
              .[] |
              "| \(.sev) | \(.id) | \(.pkg) | \(.inst) | \(.fix) | \(.title|gsub("\\n"; " ")) |"
            ' "$OUTDIR/trivy.json"
            echo ""
            echo "## Grype â€“ Top Findings (Critical/High, max 25)"
            echo ""
            echo "| Severity | ID | Package | Version | Fix |"
            echo "|---|---|---|---|---|"
            jq -r '
              [.matches[]? |
                select(.vulnerability.severity=="Critical" or .vulnerability.severity=="High") |
                {
                  sev:.vulnerability.severity,
                  id:.vulnerability.id,
                  pkg:.artifact.name,
                  ver:.artifact.version,
                  fix:(.vulnerability.fix.versions[0] // "-")
                }] |
              .[:25] |
              .[] |
              "| \(.sev) | \(.id) | \(.pkg) | \(.ver) | \(.fix) |"
            ' "$OUTDIR/grype.json"
            echo ""
            echo "> VollstÃ¤ndige JSONs: [trivy.json](./trivy.json), [grype.json](./grype.json)"
          } > "$OUT"

          # Kleines Badge in README mÃ¶glich (optional)
          # echo "![Trivy Critical $TRIVY_C](https://img.shields.io/badge/Trivy_Critical-$TRIVY_C-red)" >> "$OUT"

      - name: Commit report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(security): update container scan report"
          file_pattern: |
            ${{ env.OUTDIR }}/SCAN_REPORT.md
            ${{ env.OUTDIR }}/trivy.json
            ${{ env.OUTDIR }}/grype.json
